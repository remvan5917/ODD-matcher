<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>La rue du financement | ODD Match Analyzer Cloud</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// Your web app's Firebase configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyA7fW9f9WU_AEo26E_oTgHBIaOuwNzMQGI",
  authDomain: "odd-matcher.firebaseapp.com",
  projectId: "odd-matcher",
  storageBucket: "odd-matcher.firebasestorage.app",
  messagingSenderId: "310551376629",
  appId: "1:310551376629:web:938b3610228cabe265cbbc",
  measurementId: "G-GSQR502C0N"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
        // État Global
        let policyDB = {};
        let currentUser = null;

        // --- AUTHENTIFICATION (Règle 3) ---
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Erreur d'authentification", error);
                showStatus("Erreur de connexion au serveur.");
            }
        };

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                loadCloudData();
            }
        });

        // --- CHARGEMENT DES DONNÉES CLOUD (Règle 1 & 2) ---
        const loadCloudData = async () => {
            if (!currentUser) return;
            showStatus("Synchronisation de la base de données...");
            
            try {
                // Chemin strict : /artifacts/{appId}/public/data/policies
                const policiesCol = collection(db, 'artifacts', appId, 'public', 'data', 'policies');
                const querySnapshot = await getDocs(policiesCol);
                
                const tempDB = {};
                querySnapshot.forEach((doc) => {
                    tempDB[doc.id] = doc.data();
                });

                // Si la base cloud est vide, on utilise un fallback pour la première utilisation
                if (Object.keys(tempDB).length === 0) {
                    console.warn("Base Firestore vide. Utilisation du mode local.");
                    policyDB = fallbackDB; 
                } else {
                    policyDB = tempDB;
                }
                
                window.policyDB = policyDB; // Rendre accessible au reste du script
                showStatus("Système prêt.");
                initTagGrid();
            } catch (error) {
                console.error("Erreur de chargement", error);
                showStatus("Mode hors-ligne activé.");
                window.policyDB = fallbackDB;
                initTagGrid();
            }
        };

        // --- FALLBACK (Base de secours si Firestore est vide au premier lancement) ---
        const fallbackDB = {
            "Agriculture, forêt, pêche": { odd: "ODD 2, 14, 15", eu: "PAC 2023-2027", fr: "Plan national alimentation durable", reg: "Plan régional agriculture" },
            "Déchets, économie circulaire": { odd: "ODD 12", eu: "Pacte Vert / Directive Déchets", fr: "Feuille de route Économie Circulaire", reg: "Plan régional déchets" },
            "Eau, biodiversité, milieux": { odd: "ODD 6, 15", eu: "Stratégie Biodiversité 2030", fr: "Plan Biodiv 2030", reg: "SRCE / Trame Verte" },
            "Transition écologique environnement": { odd: "ODD 13, 7", eu: "Green Deal / REPowerEU", fr: "SNBC (Bas Carbone)", reg: "PCAET / Plan climat" },
            "Cohésion sociale et solidarité": { odd: "ODD 1, 10", eu: "FSE+ Inclusion", fr: "Stratégie Pauvreté", reg: "Action sociale" }
        };

        const showStatus = (msg) => {
            const el = document.getElementById('status-line');
            if (el) el.textContent = msg;
        };

        // Initialisation des fonctions globales pour le HTML
        window.nextStep = (step) => {
            document.querySelectorAll('.form-step').forEach(s => s.classList.add('hidden'));
            document.querySelector(`.form-step[data-step="${step}"]`).classList.remove('hidden');
            const dots = document.querySelectorAll('.step-dot');
            dots.forEach((dot, idx) => dot.classList.toggle('active', idx < step));
        };

        window.toggleTag = (el) => {
            el.classList.toggle('active');
        };

        window.generateAnalysis = () => {
            const scanner = document.getElementById('scanner');
            const output = document.getElementById('matrix-output');
            const region = document.getElementById('region').value;
            const orgName = document.getElementById('org-name').value || 'Organisation';
            const objGen = document.getElementById('gen-obj').value || "Alignement stratégique global.";
            
            const acts = [
                document.getElementById('act-1').value, 
                document.getElementById('act-2').value,
                document.getElementById('act-3').value
            ].filter(a => a.trim() !== "");

            const selectedTags = Array.from(document.querySelectorAll('.selectable-tag.active')).map(t => t.textContent);

            if (acts.length === 0 || selectedTags.length === 0) {
                alert("Données insuffisantes pour l'analyse.");
                return;
            }

            scanner.style.display = 'block';
            scanner.style.animation = 'scanAnim 2s linear forwards';

            setTimeout(() => {
                scanner.style.display = 'none';
                let oddScores = {};
                
                let html = `
                    <div class="flex justify-between items-end mb-6">
                        <div>
                            <div class="font-mono text-copper-bright text-xs uppercase">Matrice Cloud : ${orgName}</div>
                            <div class="font-mono text-[10px] opacity-60">Territoire : ${region}</div>
                        </div>
                        <button onclick="window.print()" class="border border-copper-base text-copper-base px-3 py-1 text-[10px] font-mono hover:bg-copper-base hover:text-surface">PDF</button>
                    </div>
                    <div class="matrix-scroll-wrapper border border-copper-dark">
                        <table class="matrix-table">
                            <thead>
                                <tr>
                                    <th>Objectif</th>
                                    <th>Activité</th>
                                    <th>Impact</th>
                                    <th>ODD</th>
                                    <th>Europe</th>
                                    <th>National</th>
                                    <th>Régional</th>
                                </tr>
                            </thead>
                            <tbody>`;
                
                acts.forEach((act, idx) => {
                    selectedTags.forEach((tag, tagIdx) => {
                        const data = window.policyDB[tag] || { odd: "-", eu: "-", fr: "-", reg: "-" };
                        
                        // Calcul ODD pour Radar
                        data.odd.split(', ').forEach(o => {
                            let n = o.replace('ODD ', '');
                            oddScores[n] = (oddScores[n] || 0) + 1;
                        });

                        html += `
                            <tr>
                                ${tagIdx === 0 ? `<td rowspan="${selectedTags.length}" class="font-bold text-copper-bright">${idx === 0 ? objGen : ''}</td>` : ''}
                                ${tagIdx === 0 ? `<td rowspan="${selectedTags.length}">${act}</td>` : ''}
                                <td><span class="tag-pill">${tag}</span></td>
                                <td>${data.odd}</td>
                                <td>${data.eu}</td>
                                <td>${data.fr}</td>
                                <td>${data.reg}</td>
                            </tr>`;
                    });
                });
                
                html += `</tbody></table></div><div class="h-64 mt-8"><canvas id="radarChart"></canvas></div>`;
                output.innerHTML = html;
                renderRadar(oddScores);
            }, 2000);
        };

        const renderRadar = (scores) => {
            const ctx = document.getElementById('radarChart').getContext('2d');
            const labels = Array.from({length: 17}, (_, i) => "ODD " + (i+1));
            const data = labels.map(l => scores[l.replace('ODD ', '')] || 0);

            new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: 'rgba(77, 182, 172, 0.2)',
                        borderColor: '#4db6ac',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            angleLines: { color: 'rgba(184, 115, 51, 0.2)' },
                            grid: { color: 'rgba(184, 115, 51, 0.2)' },
                            pointLabels: { color: '#b87333', font: { size: 9 } },
                            ticks: { display: false }
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        };

        const initTagGrid = () => {
            const container = document.getElementById('tag-grid');
            const list = Object.keys(window.policyDB);
            container.innerHTML = '';
            list.forEach(item => {
                const el = document.createElement('div');
                el.className = 'selectable-tag border border-copper-dark p-2 text-center text-[10px] uppercase font-mono cursor-pointer bg-copper-base/5 hover:bg-copper-base/20 rounded-sm';
                el.textContent = item;
                el.onclick = () => window.toggleTag(el);
                container.appendChild(el);
            });
        };

        // Lancement
        initAuth();

    </script>

    <style>
        :root {
            --copper-dark: #3d2b1f; --copper-base: #b87333; --copper-bright: #e3965e; --copper-polish: #ffccaa;
            --patina: #4db6ac; --surface: #0f0d0c;
        }
        body {
            background: var(--surface); color: var(--copper-polish); font-family: 'Space Grotesk', sans-serif;
            background-image: radial-gradient(circle at 50% 50%, rgba(184, 115, 51, 0.08) 0%, transparent 70%);
        }
        .machinery-container { display: grid; grid-template-columns: 450px 1fr; height: 100vh; }
        @media (max-width: 1100px) { .machinery-container { grid-template-columns: 1fr; height: auto; } }

        .input-chamber {
            background: linear-gradient(145deg, #2a1d15, #1a120d); border-right: 2px solid var(--copper-dark);
            padding: 40px; display: flex; flex-direction: column; overflow-y: auto; height: 100vh;
        }
        @media (max-width: 1100px) { .input-chamber { height: auto; border-bottom: 2px solid var(--copper-dark); } }

        h1 { font-size: 1.4rem; text-transform: uppercase; font-weight: 700; background: linear-gradient(to bottom, var(--copper-bright), var(--copper-dark)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .section-title { font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; color: var(--patina); border-bottom: 1px solid var(--copper-dark); padding-bottom: 8px; margin: 20px 0 15px 0; }

        .control-group { margin-bottom: 15px; }
        label { display: block; font-family: 'JetBrains Mono', monospace; font-size: 0.55rem; margin-bottom: 5px; color: var(--copper-base); text-transform: uppercase; }
        input, textarea, select { width: 100%; background: #110e0c; border: 1px solid var(--copper-dark); padding: 10px; color: var(--copper-bright); font-size: 0.8rem; }
        
        .tag-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 6px; }
        .selectable-tag.active { background: var(--patina); color: var(--surface); font-weight: bold; }

        .stepper { display: flex; gap: 4px; margin-bottom: 20px; }
        .step-dot { height: 3px; flex: 1; background: var(--copper-dark); }
        .step-dot.active { background: var(--patina); }

        .analysis-engine { padding: 40px; overflow: auto; background: var(--surface); }
        .matrix-scroll-wrapper { width: 100%; overflow-x: auto; background: rgba(0,0,0,0.2); }
        .matrix-table { width: 100%; border-collapse: collapse; min-width: 1000px; font-size: 0.75rem; }
        .matrix-table th { background: #1a120d; color: var(--copper-bright); font-family: 'JetBrains Mono'; padding: 12px; border: 1px solid var(--copper-dark); text-align: left; }
        .matrix-table td { padding: 12px; border: 1px solid var(--copper-dark); color: #d4c4b9; }

        .tag-pill { display: inline-block; padding: 2px 6px; border: 1px solid var(--patina); color: var(--patina); font-size: 0.55rem; font-family: 'JetBrains Mono'; }

        .btn { width: 100%; background: var(--copper-base); border: none; padding: 15px; font-family: 'JetBrains Mono'; font-weight: bold; text-transform: uppercase; color: var(--surface); cursor: pointer; margin-top: 15px; }
        #scanner { position: fixed; top: 0; left: 0; width: 100%; height: 3px; background: var(--patina); display: none; }
        @keyframes scanAnim { 0% { top: 0; } 100% { top: 100%; } }
    </style>

    <!-- Placeholder Comments Required by Prompt -->
    <!-- Chosen Palette: Industrial Copper & Patina Cloud -->
    <!-- Application Structure Plan: SPA responsive avec intégration Firebase Firestore. Système de Wizard pour la capture et moteur de rendu dynamique pour la matrice croisée. Sécurisation des données via authentification anonyme obligatoire. -->
    <!-- Visualization & Content Choices: 
        1. Radar Chart (Chart.js) : Intensité d'alignement ODD.
        2. Matrix (HTML Table) : Détails législatifs et politiques.
        3. Cloud Storage : Les politiques sont extraites de Firestore au démarrage.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
</head>
<body>

    <div id="scanner"></div>

    <div class="machinery-container">
        <aside class="input-chamber">
            <h1>La rue du financement</h1>
            <div id="status-line" class="font-mono text-[10px] text-patina opacity-60 mb-4">Initialisation...</div>

            <div class="stepper">
                <div id="dot-1" class="step-dot active"></div>
                <div id="dot-2" class="step-dot"></div>
                <div id="dot-3" class="step-dot"></div>
            </div>

            <form id="projectForm">
                <!-- STEP 1 -->
                <div class="form-step active" data-step="1">
                    <div class="section-title">01. ORGANISATION</div>
                    <div class="control-group">
                        <label>Nom de l'organisation</label>
                        <input type="text" id="org-name" placeholder="Nom structure">
                    </div>
                    <div class="control-group">
                        <label>Région</label>
                        <select id="region">
                            <option value="Île-de-France">Île-de-France</option>
                            <option value="Auvergne-Rhône-Alpes">Auvergne-Rhône-Alpes</option>
                            <option value="La Réunion">La Réunion</option>
                            <option value="National">National</option>
                        </select>
                    </div>
                    <button type="button" class="btn" onclick="window.nextStep(2)">Suivant</button>
                </div>

                <!-- STEP 2 -->
                <div class="form-step hidden" data-step="2">
                    <div class="section-title">02. PROJETS & ACTIVITÉS</div>
                    <div class="control-group">
                        <label>Objectif général</label>
                        <textarea id="gen-obj" rows="3" placeholder="Description courte"></textarea>
                    </div>
                    <div class="control-group">
                        <label>Activités spécifiques</label>
                        <input type="text" id="act-1" placeholder="Activité 1" class="mb-2">
                        <input type="text" id="act-2" placeholder="Activité 2">
                    </div>
                    <button type="button" class="btn" onclick="window.nextStep(3)">Suivant</button>
                </div>

                <!-- STEP 3 -->
                <div class="form-step hidden" data-step="3">
                    <div class="section-title">03. DOMAINES D'IMPACT</div>
                    <div class="tag-grid" id="tag-grid">
                        <!-- Rempli par Firestore -->
                    </div>
                    <button type="button" class="btn" onclick="window.generateAnalysis()">Générer la Matrice</button>
                </div>
            </form>
        </aside>

        <main class="analysis-engine">
            <div id="matrix-output">
                <div class="flex flex-col items-center justify-center h-full opacity-20">
                    <p class="font-mono text-xs">Analyse Cloud en attente.</p>
                </div>
            </div>
        </main>
    </div>

</body>
</html>
